<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Keyless Cubes Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root{
      --navy: #1e3a5f;
      --bg-light: #f5f7fa;
      --white: #ffffff;
      --accent: #1e3a5f;
      --muted: #6b7280;
      --card-shadow: 0 2px 8px rgba(0,0,0,0.08);
      --radius: 16px;
      --yellow: #fbbf24;
      --green: #10b981;
      --red: #ef4444;
    }

    * { box-sizing: border-box; margin:0; padding:0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    html,body{ height:100%; background: var(--bg-light); font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial; color:#1f2937; }

    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 24px;
      height: 100vh;
      padding: 22px;
    }

    .sidebar {
      background: var(--navy);
      border-radius: 0;
      padding: 24px 20px;
      box-shadow: none;
      border: none;
      display:flex;
      flex-direction:column;
      gap:18px;
      min-height:0;
    }

    .brand {
      display:flex; align-items:center; gap:12px;
    }
    .brand .logo {
      width:64px; height:64px; border-radius:16px; display:flex; align-items:center; justify-content:center;
      font-family:"Poppins"; color:var(--navy); font-weight:700; font-size:1.5rem;
      background: white;
      box-shadow: none;
    }
    .brand .title { font-family:"Poppins"; font-size:1.2rem; color:white; font-weight:700; }
    .brand .sub { font-size:0.9rem; color:rgba(255,255,255,0.7); margin-top:2px; }

    .nav {
      margin-top:6px;
      display:flex; flex-direction:column; gap:8px;
    }

    .nav-item {
      display:flex; align-items:center; gap:12px; padding:14px 12px; border-radius:12px;
      cursor:pointer; color:rgba(255,255,255,0.7); font-weight:500; transition: all 200ms;
      border:none;
    }
    .nav-item i { width:28px; text-align:center; font-size:1.05rem; color:rgba(255,255,255,0.7); }
    .nav-item span { font-size:0.95rem; }

    .nav-item:hover { background: rgba(255,255,255,0.1); color: white; transform: none; }
    .nav-item:hover i { color: white; }
    .nav-item.active { background: rgba(255,255,255,0.15); color: white; box-shadow: none; border:none; transform:none; }
    .nav-item.active i { color: white; }

    .spacer { flex:1; }

    .sidebar-footer { font-size:0.85rem; color:rgba(255,255,255,0.5); text-align:center; padding:8px; }

    .main {
      display:flex; flex-direction:column; gap:18px; min-height:0;
    }

    .topbar {
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:20px 24px;
      border-radius: 0;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border:none;
    }
    .topbar .title { font-family:"Poppins"; font-weight:700; font-size:1.5rem; color:var(--navy); }
    .topbar .right { display:flex; align-items:center; gap:12px; color:var(--muted); font-weight:500; }

    .search {
      background: rgba(17,24,39,0.03); padding:8px 12px; border-radius:999px; display:flex; align-items:center; gap:8px; color:var(--muted);
    }
    .search input{ border:0; outline:0; background:transparent; font-size:0.95rem; width:220px; color:#0f172a; }

    .avatar {
      width:40px; height:40px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; background: linear-gradient(135deg,#fff,#f3f4ff);
      border:1px solid rgba(17,24,39,0.04);
    }

    .content-grid {
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:18px;
      align-items:start;
    }

    .card {
      background: white;
      padding:24px;
      border-radius:16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border:1px solid rgba(0,0,0,0.06);
    }

    .stat-title { color:var(--muted); font-weight:500; font-size:0.95rem; margin-bottom:8px; }
    .stat-value { font-family:"Poppins"; font-size:2.2rem; color:var(--navy); font-weight:700; }

    .full {
      grid-column: 1 / -1;
    }

    .tabs {
      display:flex; gap:10px; align-items:center;
      padding:6px; background: transparent; margin-bottom:20px;
    }

    .tab {
      padding:12px 18px; border-radius:12px; cursor:pointer; font-weight:600; color:var(--muted);
      background: transparent; border:none; transition: all 220ms;
    }
    .tab.active { background: var(--navy); color:white; box-shadow: 0 2px 8px rgba(30,58,95,0.2); border:none; }

    table { width:100%; border-collapse:collapse; font-size:0.95rem; }
    thead th { text-align:left; padding:12px 14px; color:var(--muted); font-weight:700; border-bottom:2px solid rgba(17,24,39,0.04); background:transparent; }
    tbody td { padding:12px 14px; border-bottom:1px solid rgba(17,24,39,0.03); color:#0f172a; vertical-align:middle; }
    tbody tr:hover { background: rgba(30,58,95,0.03); }

    .badge { display:inline-block; padding:6px 12px; border-radius:8px; font-weight:600; font-size:0.85rem; }
    .badge-success { background:#d1fae5; color:#047857; }
    .badge-warning { background:#fef3c7; color:#92400e; }
    .badge-danger { background:#fee2e2; color:#991b1b; }
    .badge-info { background:#dbeafe; color:#1e40af; }

    .btn {
      padding:12px 20px; border-radius:12px; font-weight:600; border:0; cursor:pointer; 
      transition: all 200ms; display:inline-flex; align-items:center; gap:8px;
    }
    .btn-primary { background:var(--navy); color:white; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(30,58,95,0.3); }
    .btn-secondary { background: #f3f4f6; color:#1f2937; border:1px solid #e5e7eb; }
    .btn-danger { background: #dc2626; color:white; }
    .btn-sm { padding:8px 14px; font-size:0.9rem; }

    select, input { 
      padding:12px 14px; border:1px solid #e5e7eb; border-radius:10px; 
      font-size:0.95rem; outline:0; font-family:inherit; background:white;
    }
    select:focus, input:focus { border-color:var(--navy); box-shadow: 0 0 0 3px rgba(30,58,95,0.1); }

    .form-group { margin-bottom:16px; }
    .form-group label { display:block; font-weight:600; margin-bottom:6px; color:var(--muted); font-size:0.9rem; }

    .modal { 
      display:none; position:fixed; inset:0; z-index:1000; 
      background:rgba(0,0,0,0.4); backdrop-filter:blur(4px);
      align-items:center; justify-content:center;
    }
    .modal.show { display:flex; }
    .modal-content { 
      background:white; border-radius:16px; padding:24px; max-width:500px; width:90%; 
      box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn { from { transform: translateY(-20px); opacity:0; } to { transform: translateY(0); opacity:1; } }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .modal-header h3 { font-family:"Poppins"; font-size:1.3rem; }
    .modal-close { 
      cursor:pointer; font-size:1.5rem; color:var(--muted); background:none; 
      border:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center;
      border-radius:8px; transition:all 200ms;
    }
    .modal-close:hover { background:rgba(17,24,39,0.06); }

    .section { padding-top:6px; position:relative; }
    .section.hidden { display:none; }

    .empty-state { text-align:center; padding:60px 20px; color:var(--muted); }
    .empty-state i { font-size:3rem; margin-bottom:16px; opacity:0.3; display: block; }
    .empty-state p { font-size:1.05rem; }

    .loading { text-align:center; padding:40px; color:var(--muted); }
    .loading i { font-size:2rem; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .resident-controls {
      display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; align-items:center;
    }
    .resident-controls select { flex:1; min-width:200px; }
    .resident-controls .btn { flex-shrink:0; }

    .action-buttons { display:flex; gap:8px; }

    .locker-controls {
      display:flex; gap:12px; margin-bottom:20px; align-items:center;
    }
    .locker-controls select { min-width:200px; }

    .locker-grid-container {
      display:grid;
      gap:24px;
    }

    .locker-size-section {
      background: white;
      padding:24px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,0.06);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .locker-size-header {
      font-family:"Poppins";
      font-weight:700;
      font-size:1.15rem;
      margin-bottom:20px;
      color:var(--navy);
      display:flex;
      align-items:center;
      gap:8px;
    }

    .locker-grid {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap:12px;
    }

    .locker-box {
      aspect-ratio: 1;
      border-radius:16px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:0.9rem;
      cursor:pointer;
      transition: all 200ms;
      border:2px solid;
      position:relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    .locker-box.available {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color:#047857;
      border-color:#10b981;
    }

    .locker-box.occupied {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color:#92400e;
      border-color:#fbbf24;
    }

    .locker-box.maintenance {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color:#991b1b;
      border-color:#ef4444;
    }

    .locker-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .locker-number {
      font-size:1.1rem;
      margin-bottom:4px;
    }

    .locker-status-text {
      font-size:0.7rem;
      text-transform:uppercase;
      opacity:0.8;
    }

    .locker-legend {
      display:flex;
      gap:24px;
      margin-top:24px;
      padding:20px;
      background:white;
      border-radius:12px;
      flex-wrap:wrap;
      border:1px solid rgba(0,0,0,0.06);
    }

    .legend-item {
      display:flex;
      align-items:center;
      gap:8px;
      font-size:0.9rem;
    }

    .legend-box {
      width:24px;
      height:24px;
      border-radius:6px;
      border:2px solid;
    }

    @media (max-width: 1000px) {
      .app { grid-template-columns: 220px 1fr; padding:16px; gap:14px; }
      .content-grid { grid-template-columns: repeat(2, 1fr); }
      .locker-grid { grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); }
    }
    @media (max-width: 720px) {
      .app { grid-template-columns: 1fr; padding:12px; }
      .sidebar { flex-direction:row; gap:8px; padding:10px; overflow:auto; border-radius:10px; }
      .nav { display:flex; flex-direction:row; gap:8px; overflow-x:auto; }
      .brand .title { display:none; }
      .topbar { padding:10px; }
      .content-grid { grid-template-columns: 1fr; }
      .search input { width:120px; }
      .resident-controls { flex-direction:column; }
      .resident-controls select { width:100%; }
      .locker-grid { grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand" style="margin-bottom: 6px;">
        <div class="logo">KC</div>
        <div>
          <div class="title">Keyless Cubes</div>
          <div class="sub">Admin Dashboard</div>
        </div>
      </div>

      <nav class="nav">
        <div class="nav-item active" onclick="showTab('active')">
          <i class="fas fa-clock"></i><span>Active Deliveries</span>
        </div>
        <div class="nav-item" onclick="showTab('recent')">
          <i class="fas fa-history"></i><span>Recent Collections</span>
        </div>
        <div class="nav-item" onclick="showTab('lockers')">
          <i class="fas fa-lock"></i><span>Locker Status</span>
        </div>
        <div class="nav-item" onclick="showTab('residents')">
          <i class="fas fa-users"></i><span>Manage Residents</span>
        </div>
      </nav>
      
      <div class="spacer"></div>

      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="sidebar-footer">Last updated: <span id="lastUpdated">—</span></div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <div class="title">Keyless Cubes Admin Dashboard</div>
          <div style="font-size:0.85rem;color:var(--muted);margin-top:4px">Real-time monitoring and management</div>
        </div>
        <div class="right">
          <div class="search">
            <i class="fas fa-search"></i>
            <input placeholder="Search by locker, flat, mobile…" />
          </div>
          <button class="btn btn-secondary btn-sm" onclick="logout()" title="Logout">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:12px;min-height:0;overflow:auto;padding-bottom:6px;">
        <div class="content-grid">
          <div class="card">
            <div class="stat-title">Deliveries Today</div>
            <div class="stat-value" id="deliveriesToday">-</div>
          </div>
          <div class="card">
            <div class="stat-title">Active Deliveries</div>
            <div class="stat-value" id="activeDeliveries">-</div>
          </div>
          <div class="card">
            <div class="stat-title">Collected Today</div>
            <div class="stat-value" id="collectedToday">-</div>
          </div>
          <div class="card">
            <div class="stat-title">Available Lockers</div>
            <div class="stat-value" id="availableLockers">-</div>
          </div>

          <div class="card full" style="padding:12px 14px;">
            <div class="tabs">
              <div class="tab active" onclick="showTab('active')">
                <i class="fas fa-clock" style="margin-right:8px;color:var(--muted)"></i> Active Deliveries
              </div>
              <div class="tab" onclick="showTab('recent')">
                <i class="fas fa-history" style="margin-right:8px;color:var(--muted)"></i> Recent Collections
              </div>
              <div class="tab" onclick="showTab('lockers')">
                <i class="fas fa-lock" style="margin-right:8px;color:var(--muted)"></i> Locker Status
              </div>
              <div class="tab" onclick="showTab('residents')">
                <i class="fas fa-users" style="margin-right:8px;color:var(--muted)"></i> Residents
              </div>
            </div>

            <!-- Active Deliveries -->
            <div id="activeTab" class="section">
              <div style="padding:0 6px 12px 6px; display:flex;justify-content:space-between;align-items:center">
                <h2 style="font-size:1.05rem;margin:0;color:#0f172a">Active Deliveries</h2>
                <button class="btn btn-secondary btn-sm" onclick="refreshData()">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>
              <div id="activeDeliveriesTable">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Loading data...</p></div>
              </div>
            </div>

            <!-- Recent -->
            <div id="recentTab" class="section hidden">
              <div style="padding:0 6px 12px 6px; display:flex;justify-content:space-between;align-items:center">
                <h2 style="font-size:1.05rem;margin:0;color:#0f172a">Recent Collections</h2>
                <button class="btn btn-secondary btn-sm" onclick="refreshData()">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>
              <div id="recentCollectionsTable">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Loading data...</p></div>
              </div>
            </div>

            <!-- Lockers -->
            <div id="lockersTab" class="section hidden">
              <div style="padding:0 6px 12px 6px; display:flex;justify-content:space-between;align-items:center">
                <h2 style="font-size:1.05rem;margin:0;color:#0f172a">Locker Status</h2>
                <button class="btn btn-secondary btn-sm" onclick="refreshData()">
                  <i class="fas fa-sync-alt"></i> Refresh
                </button>
              </div>
              <div class="locker-controls">
                <select id="towerSelectLocker" onchange="loadLockersByTower()">
                  <option value="">Select Tower...</option>
                </select>
              </div>
              <div id="lockersStatusDisplay">
                <div class="empty-state">
                  <i class="fas fa-building"></i>
                  <p>Select a tower to view locker status</p>
                </div>
              </div>
            </div>

            <!-- Residents -->
            <div id="residentsTab" class="section hidden">
              <div style="padding:0 6px 12px 6px">
                <h2 style="font-size:1.05rem;margin:0 0 16px 0;color:#0f172a">Manage Residents</h2>
                <div class="resident-controls">
                  <select id="towerSelect" onchange="loadApartments()">
                    <option value="">Select Tower...</option>
                  </select>
                  <select id="apartmentSelect" onchange="loadResidents()">
                    <option value="">Select Apartment...</option>
                  </select>
                  <button class="btn btn-primary btn-sm" onclick="showAddResidentModal()">
                    <i class="fas fa-plus"></i> Add Resident
                  </button>
                </div>
              </div>
              <div id="residentsTable">
                <div class="empty-state">
                  <i class="fas fa-users"></i>
                  <p>Select tower and apartment to view residents</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Resident Modal -->
  <div id="residentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Add Resident</h3>
        <button class="modal-close" onclick="closeResidentModal()">×</button>
      </div>
      <form id="residentForm" onsubmit="saveResident(event)">
        <input type="hidden" id="residentId">
        <div class="form-group">
          <label>Tower *</label>
          <select id="modalTower" required>
            <option value="">Select Tower...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Apartment Number *</label>
          <input type="text" id="flatNumber" required placeholder="e.g., A-101">
        </div>
        <div class="form-group">
          <label>Full Name *</label>
          <input type="text" id="fullName" required placeholder="Enter full name">
        </div>
        <div class="form-group">
          <label>Mobile Number *</label>
          <input type="tel" id="mobile" required pattern="[6-9][0-9]{9}" placeholder="10-digit mobile">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="email" placeholder="email@example.com">
        </div>
        <div class="form-group">
          <label>Alternate Mobile</label>
          <input type="tel" id="alternateMobile" pattern="[6-9][0-9]{9}" placeholder="10-digit mobile">
        </div>
        <div style="display:flex;gap:12px;margin-top:20px">
          <button type="submit" class="btn btn-primary" style="flex:1">
            <i class="fas fa-save"></i> Save
          </button>
          <button type="button" class="btn btn-secondary" onclick="closeResidentModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = 'api';
    let currentTab = 'active';
    let towers = [];
    let allLockers = [];

    document.addEventListener('DOMContentLoaded', function() {
      checkAdminSession();
      loadDashboardStats();
      loadActiveDeliveries();
      loadTowers();
    });
    
    async function checkAdminSession() {
      try {
        const response = await fetch(`${API_BASE}/admin_auth.php?action=check_session`);
        const result = await response.json();
        
        if (!result.success || !result.logged_in) {
          window.location.href = 'admin_login.html';
          return;
        }
        
        console.log('Logged in as:', result.admin.full_name);
      } catch (error) {
        console.error('Session check error:', error);
        window.location.href = 'admin_login.html';
      }
    }

    async function logout() {
      if (!confirm('Are you sure you want to logout?')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/admin_auth.php?action=logout`);
        const result = await response.json();
        
        if (result.success) {
          window.location.href = 'admin_login.html';
        } else {
          alert('Logout failed. Please try again.');
        }
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = 'admin_login.html';
      }
    }

    function showTab(tabName) {
      document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
      document.querySelectorAll('.nav-item, .tab').forEach(e => e.classList.remove('active'));
      
      document.getElementById(tabName + 'Tab').classList.remove('hidden');
      
      document.querySelectorAll('.nav-item, .tab').forEach(e => {
        const text = e.textContent.toLowerCase();
        if ((tabName === 'active' && text.includes('active')) ||
            (tabName === 'recent' && text.includes('recent')) ||
            (tabName === 'lockers' && text.includes('locker')) ||
            (tabName === 'residents' && text.includes('resident'))) {
          e.classList.add('active');
        }
      });
      
      currentTab = tabName;
      
      switch(tabName) {
        case 'active': loadActiveDeliveries(); break;
        case 'recent': loadRecentCollections(); break;
        case 'lockers': loadAllLockers(); break;
        case 'residents': loadTowers(); break;
      }
    }
    
    function refreshData() {
      loadDashboardStats();
      showTab(currentTab);
      document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
    }

    async function loadDashboardStats() {
      try {
        const response = await fetch(`${API_BASE}/admin_dashboard.php?action=dashboard_stats`);
        const result = await response.json();
        if (result.success) {
          const s = result.stats;
          document.getElementById('deliveriesToday').textContent = s.deliveries_today;
          document.getElementById('activeDeliveries').textContent = s.active_deliveries;
          document.getElementById('collectedToday').textContent = s.collected_today;
          document.getElementById('availableLockers').textContent = s.available_lockers;
          document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function loadActiveDeliveries() {
      const container = document.getElementById('activeDeliveriesTable');
      container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i></div>';
      try {
        const response = await fetch(`${API_BASE}/admin_dashboard.php?action=active_deliveries`);
        const result = await response.json();
        if (result.success && result.deliveries.length > 0) {
          let html = '<table><thead><tr><th>Locker</th><th>Tower</th><th>Flat</th><th>Resident</th><th>Mobile</th><th>Size</th><th>Deposited</th><th>Hours</th><th>OTP</th></tr></thead><tbody>';
          result.deliveries.forEach(d => {
            html += `<tr><td><strong>${d.locker_number}</strong></td><td>${d.tower_name || '-'}</td><td>${d.flat_number}</td><td>${d.full_name}</td><td>${d.mobile}</td><td><span class="badge badge-info">${d.package_size}</span></td><td>${formatDateTime(d.deposited_at)}</td><td>${d.hours_in_locker}h</td><td><code>${d.otp}</code></td></tr>`;
          });
          html += '</tbody></table>';
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No active deliveries at the moment</p></div>';
        }
      } catch (error) {
        container.innerHTML = '<div class="empty-state"><p>Error loading data</p></div>';
      }
    }

    async function loadRecentCollections() {
      const container = document.getElementById('recentCollectionsTable');
      container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i></div>';
      try {
        const response = await fetch(`${API_BASE}/admin_dashboard.php?action=recent_collections&limit=10`);
        const result = await response.json();
        if (result.success && result.collections.length > 0) {
          let html = '<table><thead><tr><th>Locker</th><th>Flat</th><th>Resident</th><th>Deposited</th><th>Collected</th></tr></thead><tbody>';
          result.collections.forEach(c => {
            html += `<tr><td>${c.locker_number}</td><td>${c.flat_number}</td><td>${c.full_name}</td><td>${formatDateTime(c.deposited_at)}</td><td>${formatDateTime(c.collected_at)}</td></tr>`;
          });
          html += '</tbody></table>';
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="empty-state"><i class="fas fa-history"></i><p>No recent collections</p></div>';
        }
      } catch (error) {
        container.innerHTML = '<div class="empty-state"><p>Error loading data</p></div>';
      }
    }

    async function loadAllLockers() {
      try {
        const response = await fetch(`${API_BASE}/admin_dashboard.php?action=locker_status`);
        const result = await response.json();
        
        if (result.success) {
          // Ensure all location_id values are integers
          allLockers = result.lockers.map(l => ({
            ...l,
            location_id: parseInt(l.location_id)
          }));
          
          const towerSelect = document.getElementById('towerSelectLocker');
          
          // Group by location_id and get unique towers
          const towerMap = new Map();
          allLockers.forEach(l => {
            if (!towerMap.has(l.location_id)) {
              towerMap.set(l.location_id, {
                location_id: l.location_id,
                society_name: l.society_name,
                tower_name: l.tower_name || `Tower ${l.location_id}`
              });
            }
          });
          
          towerSelect.innerHTML = '<option value="">Select Tower...</option>';
          towerMap.forEach((tower, locationId) => {
            const option = document.createElement('option');
            option.value = locationId;
            option.textContent = `${tower.society_name} - ${tower.tower_name}`;
            towerSelect.appendChild(option);
          });
          
          document.getElementById('lockersStatusDisplay').innerHTML = `
            <div class="empty-state">
              <i class="fas fa-building"></i>
              <p>Select a tower to view locker status</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading lockers:', error);
      }
    }

    function loadLockersByTower() {
      const selectedLocationId = parseInt(document.getElementById('towerSelectLocker').value);
      const container = document.getElementById('lockersStatusDisplay');
      
      console.log('Selected location ID:', selectedLocationId);
      console.log('All lockers available:', allLockers);
      
      if (!selectedLocationId) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-building"></i>
            <p>Select a tower to view locker status</p>
          </div>
        `;
        return;
      }
      
      // Filter by location_id instead of society_name
      const towerLockers = allLockers.filter(l => l.location_id === selectedLocationId);
      console.log('Filtered lockers for location', selectedLocationId, ':', towerLockers);
      
      const small = towerLockers.filter(l => l.size === 'small');
      const medium = towerLockers.filter(l => l.size === 'medium');
      const large = towerLockers.filter(l => l.size === 'large');
      
      console.log('Small:', small.length, 'Medium:', medium.length, 'Large:', large.length);
      
      let html = '<div class="locker-grid-container">';
      
      if (small.length > 0) {
        html += `
          <div class="locker-size-section">
            <div class="locker-size-header">
              <i class="fas fa-box" style="color:var(--accent)"></i>
              Small Lockers
            </div>
            <div class="locker-grid">
              ${small.map(l => createLockerBox(l)).join('')}
            </div>
          </div>
        `;
      }
      
      if (medium.length > 0) {
        html += `
          <div class="locker-size-section">
            <div class="locker-size-header">
              <i class="fas fa-cube" style="color:var(--accent)"></i>
              Medium Lockers
            </div>
            <div class="locker-grid">
              ${medium.map(l => createLockerBox(l)).join('')}
            </div>
          </div>
        `;
      }
      
      if (large.length > 0) {
        html += `
          <div class="locker-size-section">
            <div class="locker-size-header">
              <i class="fas fa-cubes" style="color:var(--accent)"></i>
              Large Lockers
            </div>
            <div class="locker-grid">
              ${large.map(l => createLockerBox(l)).join('')}
            </div>
          </div>
        `;
      }
      
      html += '</div>';
      
      html += `
        <div class="locker-legend">
          <div class="legend-item">
            <div class="legend-box" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-color:#10b981;"></div>
            <span>Available</span>
          </div>
          <div class="legend-item">
            <div class="legend-box" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-color:#fbbf24;"></div>
            <span>Occupied</span>
          </div>
          <div class="legend-item">
            <div class="legend-box" style="background: linear-gradient(135deg, #fee2e2, #fecaca); border-color:#ef4444;"></div>
            <span>Maintenance</span>
          </div>
        </div>
      `;
      
      console.log('Generated HTML length:', html.length);
      container.innerHTML = html;
    }

    function createLockerBox(locker) {
      const statusClass = locker.status;
      const statusText = locker.status.charAt(0).toUpperCase() + locker.status.slice(1);
      const occupantInfo = locker.flat_number ? `<div style="font-size:0.75rem;margin-top:2px;">${locker.flat_number}</div>` : '';
      
      return `
        <div class="locker-box ${statusClass}" title="${locker.locker_number} - ${statusText}${locker.flat_number ? ' - ' + locker.flat_number : ''}">
          <div class="locker-number">${locker.locker_number}</div>
          ${occupantInfo}
          <div class="locker-status-text">${statusText}</div>
        </div>
      `;
    }
    

    async function loadTowers() {
      try {
        const response = await fetch(`${API_BASE}/deposit_delivery.php?action=get_towers`);
        const result = await response.json();
        if (result.success) {
          towers = result.towers;
          const selects = [document.getElementById('towerSelect'), document.getElementById('modalTower')];
          selects.forEach(select => {
            select.innerHTML = '<option value="">Select Tower...</option>';
            towers.forEach(t => {
              select.innerHTML += `<option value="${t.id}">${t.tower_name} - ${t.society_name}</option>`;
            });
          });
        }
      } catch (error) {
        console.error('Error loading towers:', error);
      }
    }

    async function loadApartments() {
      const towerId = document.getElementById('towerSelect').value;
      const aptSelect = document.getElementById('apartmentSelect');
      aptSelect.innerHTML = '<option value="">Select Apartment...</option>';
      document.getElementById('residentsTable').innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>Select apartment to view residents</p></div>';
      
      if (!towerId) return;
      
      try {
        const response = await fetch(`${API_BASE}/deposit_delivery.php?action=get_flats&location_id=${towerId}`);
        const result = await response.json();
        if (result.success) {
          result.flats.forEach(flat => {
            aptSelect.innerHTML += `<option value="${flat}">${flat}</option>`;
          });
        }
      } catch (error) {
        console.error('Error loading apartments:', error);
      }
    }

    async function loadResidents() {
      const towerId = document.getElementById('towerSelect').value;
      const flatNumber = document.getElementById('apartmentSelect').value;
      const container = document.getElementById('residentsTable');
      
      if (!towerId || !flatNumber) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>Select tower and apartment</p></div>';
        return;
      }
      
      container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i></div>';
      
      try {
        const response = await fetch(`${API_BASE}/resident_management.php?action=get_residents&location_id=${towerId}&flat_number=${flatNumber}`);
        const result = await response.json();
        
        if (result.success && result.residents.length > 0) {
          let html = '<table><thead><tr><th>Apartment</th><th>Name</th><th>Mobile</th><th>Email</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
          result.residents.forEach(r => {
            const badge = r.status === 'active' ? 'badge-success' : 'badge-danger';
            html += `
              <tr>
                <td><strong>${r.flat_number}</strong></td>
                <td>${r.full_name}</td>
                <td>${r.mobile}</td>
                <td>${r.email || '-'}</td>
                <td><span class="badge ${badge}">${r.status}</span></td>
                <td>
                  <div class="action-buttons">
                    <button class="btn btn-sm btn-secondary" onclick='editResident(${JSON.stringify(r).replace(/'/g, "&apos;")})' title="Edit">
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteResident(${r.id}, '${r.full_name}')" title="Delete">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `;
          });
          html += '</tbody></table>';
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="empty-state"><i class="fas fa-user-slash"></i><p>No residents found for this apartment</p></div>';
        }
      } catch (error) {
        container.innerHTML = '<div class="empty-state"><p>Error loading residents</p></div>';
      }
    }

    function showAddResidentModal() {
      const towerId = document.getElementById('towerSelect').value;
      const flatNumber = document.getElementById('apartmentSelect').value;
      
      document.getElementById('modalTitle').textContent = 'Add Resident';
      document.getElementById('residentForm').reset();
      document.getElementById('residentId').value = '';
      
      if (towerId) {
        document.getElementById('modalTower').value = towerId;
        document.getElementById('modalTower').disabled = true;
      } else {
        document.getElementById('modalTower').disabled = false;
      }
      
      if (flatNumber) {
        document.getElementById('flatNumber').value = flatNumber;
        document.getElementById('flatNumber').readOnly = true;
      } else {
        document.getElementById('flatNumber').readOnly = false;
      }
      
      document.getElementById('residentModal').classList.add('show');
    }

    function editResident(resident) {
      document.getElementById('modalTitle').textContent = 'Edit Resident';
      document.getElementById('residentId').value = resident.id;
      document.getElementById('modalTower').value = resident.location_id;
      document.getElementById('modalTower').disabled = true;
      document.getElementById('flatNumber').value = resident.flat_number;
      document.getElementById('flatNumber').readOnly = true;
      document.getElementById('fullName').value = resident.full_name;
      document.getElementById('mobile').value = resident.mobile;
      document.getElementById('email').value = resident.email || '';
      document.getElementById('alternateMobile').value = resident.alternate_mobile || '';
      
      document.getElementById('residentModal').classList.add('show');
    }

    function closeResidentModal() {
      document.getElementById('residentModal').classList.remove('show');
      document.getElementById('residentForm').reset();
      document.getElementById('modalTower').disabled = false;
      document.getElementById('flatNumber').readOnly = false;
    }

    async function saveResident(event) {
      event.preventDefault();
      
      const formData = new FormData();
      const residentId = document.getElementById('residentId').value;
      
      if (residentId) {
        formData.append('action', 'update_resident');
        formData.append('id', residentId);
      } else {
        formData.append('action', 'add_resident');
        formData.append('location_id', document.getElementById('modalTower').value);
        formData.append('flat_number', document.getElementById('flatNumber').value);
      }
      
      formData.append('full_name', document.getElementById('fullName').value);
      formData.append('mobile', document.getElementById('mobile').value);
      formData.append('email', document.getElementById('email').value);
      formData.append('alternate_mobile', document.getElementById('alternateMobile').value);
      formData.append('status', 'active');
      
      try {
        const response = await fetch(`${API_BASE}/resident_management.php`, {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        
        if (result.success) {
          alert(result.message);
          closeResidentModal();
          loadResidents();
        } else {
          alert('Error: ' + result.message);
        }
      } catch (error) {
        alert('Error saving resident: ' + error.message);
      }
    }

    async function deleteResident(residentId, residentName) {
      if (!confirm(`Are you sure you want to deactivate ${residentName}?`)) {
        return;
      }
      
      const formData = new FormData();
      formData.append('action', 'delete_resident');
      formData.append('id', residentId);
      
      try {
        const response = await fetch(`${API_BASE}/resident_management.php`, {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        
        if (result.success) {
          alert(result.message);
          loadResidents();
        } else {
          alert('Error: ' + result.message);
        }
      } catch (error) {
        alert('Error deleting resident: ' + error.message);
      }
    }

    function formatDateTime(datetime) {
      if (!datetime) return '-';
      const date = new Date(datetime);
      return date.toLocaleString('en-GB', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
  </script>
</body>
</html>